---
title: "Scotland segmented under 75"
output:
  word_document: default
  html_notebook: default
---

```{r setup, include=FALSE, echo=FALSE}
require("knitr")
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

# Introduction

To undertake segmented regression (one and two break) for Scotland age group under 75 years. Employs full data range available (Q1 1990-Q2 2018)

* Load packages
* Load data
* Ensure correctly labelled
* Convert dates to identifiable quarters
* Limit under 75
* Generate linear model
* Generate segmented 
* Run Davies test

## Load packages

```{r}
#install.packages("pacman")
pacman::p_load(
  tidyverse,
  segmented,
  plotly,
  dplyr,
  readr,
  ggplot2,
  broom,
  tidyr
               )
```

## Load data and assign to object "data"

```{r}
data <- read.csv("Data/QuarterlyASMR1990_2018_UNDER75.csv")
data
```

#Tidy periods into quarters, select all age variables, filter to M&F only
```{r}

tidied_UNDER75rates <-
  data %>%
  separate(Quarter, into = c("year","quarter"), sep = 4) %>% 
  mutate(
   year = as.double(year),
   quarter = as.double(quarter)
  ) %>% 
  mutate(
    time = year + (quarter / 4) - 0.125
  ) %>% 
  select(time, Sex, Rate)%>%
  rename(sex=Sex)


tidied_UNDER75rates

```

# plot mortality rates by time
```{r}
plot<-ggplot(tidied_UNDER75rates,aes(x=time,y=Rate, color=sex))+geom_line(size=1.0001, show.legend = TRUE)+theme(text=element_text(size=14))
plot
```

# Segmented regression 
##Generate linear model for both sexes

```{r}
tidied_UNDER75rates %>% 
  filter(sex == "M") -> U75male
  lm(Rate ~ time, data = U75male) -> lmodU75_male

tidied_UNDER75rates %>%
  filter(sex == "F") -> U75female
  lm(Rate ~ time, data = U75female) -> lmodU75_female

```

##View linear model 

```{r}
summary (lmodU75_male)
summary (lmodU75_female)

```


## Davies test 
```{r}
davies_U75male = davies.test(lmodU75_male, ~time, k=111)
davies_U75female = davies.test(lmodU75_female, ~time, k=111)
davies_U75male
davies_U75female
```
  
## Get trend line of linear model fit to whole timeseries 
  

```{r}
my.coeftrendlineU75male <- coef(lmodU75_male)
my.coeftrendlineU75female <- coef(lmodU75_female)
addtrendline <- plot + geom_abline(intercept = my.coeftrendlineU75male[1], col="Blue", size=1.0001,
                                       slope = my.coeftrendlineU75male[2], 
                                       aes(colour = "Overall"))+
  geom_abline(intercept = my.coeftrendlineU75female[1], col="Blue", size=1.0001,
                                       slope = my.coeftrendlineU75female[2], 
                                       aes(colour = "Overall"))
addtrendline
```
## Segmented regression function - one break point

```{r}
 my.seg_male_U75<-segmented(  lmodU75_male, seg_rate.Z = ~time, psi = NA, control = seg.control(K=1))
 my.seg_female_U75<-segmented(  lmodU75_female, seg_rate.Z = ~time, psi = NA, control = seg.control(K=1))

```
  
## outputs from segmented function

```{r}
summary(my.seg_male_U75)
summary(my.seg_female_U75)
my.fitted_male_U75 <- fitted(my.seg_male_U75)
my.fitted_female_U75 <- fitted(my.seg_female_U75)

```
#Extract breakpoint and CI

```{r}
breakpointmale_U75 <- my.seg_male_U75$psi[, 2]
breakpointfemale_U75 <- my.seg_female_U75$psi[, 2]
breakpoint_SEmale_U75 <- my.seg_male_U75$psi[, 3]
breakpoint_SEfemale_U75 <- my.seg_female_U75$psi[, 3]
breakpoint_low_CImale_U75 <- breakpointmale_U75 - (breakpoint_SEmale_U75*1.96)
breakpoint_up_CImale_U75 <- breakpointmale_U75 + (breakpoint_SEmale_U75*1.96)
breakpoint_low_CIfemale_U75 <- breakpointfemale_U75 - (breakpoint_SEfemale_U75*1.96)
breakpoint_up_CIfemale_U75 <- breakpointfemale_U75 + (breakpoint_SEfemale_U75*1.96)

breakpointmale_U75
breakpoint_low_CImale_U75
breakpoint_up_CImale_U75
breakpointfemale_U75
breakpoint_low_CIfemale_U75
breakpoint_up_CIfemale_U75
```  
#Plot model
```{r}
tidied_UNDER75rates %>% 
  filter(sex =="M") %>% 
  ggplot(
    aes(x = time)
  ) + 
  geom_point(
    aes(y = Rate)
  ) + 
  geom_line(
    aes(y = my.fitted_male_U75)
  )
tidied_UNDER75rates %>% 
  filter(sex =="F") %>% 
  ggplot(
    aes(x = time)
  ) + 
  geom_point(
    aes(y = Rate)
  ) + 
  geom_line(
    aes(y = my.fitted_female_U75) 
  )
```

#Model predicted values to data frame tidied_allagerates

```{r}
tidied_UNDER75rates %>%
  filter(sex == "M") %>% 
  mutate(
    onebreak_fit_U75 = fitted(
      my.seg_male_U75 
     
      )
    ) -> malefitted_U75

tidied_UNDER75rates %>%
  filter(sex == "F") %>% 
  mutate(
    onebreak_fit_U75 = fitted(
      my.seg_female_U75 

      )
    ) -> femalefitted_U75
plot(malefitted_U75$onebreak_fit_U75)
plot(femalefitted_U75$onebreak_fit_U75)
```

##Combine male and female observed and predicted

```{r}
femalefitted_U75 %>% 
  select(
    time, sex, observed = Rate,
    predicted = onebreak_fit_U75
  ) %>% 
  bind_rows(
    malefitted_U75 %>% 
      select(
        time, sex, observed = Rate,
        predicted = onebreak_fit_U75
      ) 
  ) -> obs_fit_both_U75

age <- "under75"
obs_fit_both_U75$agegroup = age

obs_fit_both_U75
```

#Plot obs, predicted, and lm

```{r}
obs_fit_both_U75 %>% 
  ggplot(
    aes (x=time, color=sex)
  ) +
  geom_point(
    aes (y=observed)) +
  geom_line ( 
    aes (y=predicted)) +
  stat_smooth(method="lm",se=F,linetype="dashed",
    aes (y=observed)
  )
```

##Getsegmented regression coefficients
```{r}
coef(my.seg_male_U75)
coef(my.seg_female_U75)
```


##Plot using coefficients and geom_abline
```{r}
 # Get coeffiencents male
  b0_aspec_m_U75 <- coef(my.seg_male_U75)[[1]]
  b1_aspec_m_U75 <- coef(my.seg_male_U75)[[2]]
  c1_aspec_m_U75 <- coef(my.seg_male_U75)[[2]] + coef(my.seg_male_U75)[[3]]
  
  break1_aspec_m_U75 <- my.seg_male_U75$psi[[2]]
  
  # Get coefficients female
    b0_aspec_f_U75 <- coef(my.seg_female_U75)[[1]]
  b1_aspec_f_U75 <- coef(my.seg_female_U75)[[2]]
  c1_aspec_f_U75 <- coef(my.seg_female_U75)[[2]] + coef(my.seg_female_U75)[[3]]
  
  break1_aspec_f_U75 <- my.seg_female_U75$psi[[2]]
  
# plot
 p <- obs_fit_both_U75 %>% 
  ggplot(
    aes (x=time, color=sex)
  ) +
  geom_point(
    aes (y=observed), alpha=0.4) +
  geom_line (
    aes (y=predicted), size=1) +
  geom_abline(intercept = b0_aspec_m_U75, slope = b1_aspec_m_U75, color="#00BFC4", linetype="dashed") +
    geom_abline(intercept = b0_aspec_f_U75, slope = b1_aspec_f_U75, color="#F8766D", linetype= "dashed") +
    ylim(0,1200)+
    labs(x="Year", y="Age-standardised mortality rate", title = 
        "Age-standardised quarterly rolling annual mortality rates 
         and fitted segmented model, males and females, under 75 years, 
         Scotland, 1990 to 2018") +
    scale_x_continuous (breaks=c(1990, 1994, 1998, 2002, 2006, 2010, 2014, 2018))+
    geom_vline(xintercept = my.seg_male_U75[["psi"]][[2]], color = "#00BFC4", linetype="dotdash")+
    geom_vline(xintercept = my.seg_female_U75[["psi"]][[2]], color = "#F8766D", linetype="dotdash") +
   annotate(geom="text", x=2016, y=110, label="MaleU75\nbreakpoint\nJuly 2012-\n Jun 2013 ")+
   annotate(geom="text", x=2010, y=110, label="FemaleU75\nbreakpoint\nOct 2011-\nSep2012")
   
 
 plot(p)

 
    ggsave (
    "Figures/Segmentedplot_Scotland_U75.png", height=15, width=20, units="cm")

```

##Build up chart layers

```{r}
observedplot_U75 <- obs_fit_both_U75 %>% 
  ggplot(
    aes (x=time, color=sex)
  ) +
  geom_point(
    aes (y=observed), alpha=0.4)+
   ylim(0,1200)+
    labs(x="Year", y="Age-standardised mortality rate", title = 
        "Age-standardised quarterly rolling annual mortality rates", subtitles="males and females, under 75, Scotland, 1990 to 2018")+
  scale_x_continuous (breaks=c(1990, 1994, 1998, 2002, 2006, 2010, 2014, 2018))
    
ggsave (
    "Figures/observedplot_Scotland_U75.png", height=15, width=20, units="cm")


linearplot_U75 <- obs_fit_both_U75 %>% 
  ggplot(
    aes (x=time, color=sex)
  ) +
  geom_point(
    aes (y=observed), alpha=0.4)+
  geom_abline(intercept = my.coeftrendlineU75male[1], col="#00BFC4", size=1.0001,
                                       slope = my.coeftrendlineU75male[2])+
  geom_abline(intercept = my.coeftrendlineU75female[1], col="#F8766D", size=1.0001,
                                       slope = my.coeftrendlineU75female[2])+
   ylim(0,1200)+
    labs(x="Year", y="Age-standardised mortality rate", title = "Age-standardised quarterly rolling annual mortality rates", subtitles="males and females, under 75, Scotland, 1990 to 2018: linear model fitted"
        )+
  scale_x_continuous (breaks=c(1990, 1994, 1998, 2002, 2006, 2010, 2014, 2018))

    ggsave (
    "Figures/linearplot_Scotland_U75.png", height=15, width=20, units="cm")

segmentedplot <- obs_fit_both_U75 %>% 
  ggplot(
    aes (x=time, color=sex)
  ) +
  geom_point(
    aes (y=observed), alpha=0.4)+
  geom_line (
    aes (y=predicted), size=1) +
  #geom_abline(intercept = b0_aspec_m, slope = b1_aspec_m, color="#00BFC4", linetype="dashed") +
   # geom_abline(intercept = b0_aspec_f, slope = b1_aspec_f, color="#F8766D", linetype= "dashed") +
    ylim(0,1200)+
    labs(x="Year", y="Age-standardised mortality rate", title = "Age-standardised quarterly rolling annual mortality rates", subtitles="males and females, under 75, Scotland, 1990 to 2018: one-break segmented model fitted")+
  scale_x_continuous (breaks=c(1990, 1994, 1998, 2002, 2006, 2010, 2014, 2018))

    ggsave (
    "Figures/segmentedplotonly_Scotland_Allages.png", height=15, width=20, units="cm")

annotatedsegmentedplot_U75 <- obs_fit_both_U75 %>% 
  ggplot(
    aes (x=time, color=sex)
  ) +
  geom_point(
    aes (y=observed), alpha=0.4)+
  geom_line (
    aes (y=predicted), size=1) +
  geom_abline(intercept = b0_aspec_m_U75, slope = b1_aspec_m_U75, color="#00BFC4", linetype="dashed") +
  geom_abline(intercept = b0_aspec_f_U75, slope = b1_aspec_f_U75, color="#F8766D", linetype= "dashed") +
    ylim(0,1200)+
    labs(x="Year", y="Age-standardised mortality rate", title = "Age-standardised quarterly rolling annual mortality rates", subtitles="males and females, under 75, Scotland, 1990 to 2018: 
         one-break segmented model and continuation of previous trend")+
  scale_x_continuous (breaks=c(1990, 1994, 1998, 2002, 2006, 2010, 2014, 2018))+
      geom_vline(xintercept = my.seg_male_U75[["psi"]][[2]], color = "#00BFC4", linetype="dotdash")+
    geom_vline(xintercept = my.seg_female_U75[["psi"]][[2]], color = "#F8766D", linetype="dotdash") +
   annotate(geom="text", x=2016, y=110, label="MaleU75\nbreakpoint\nJuly 2012-\n Jun 2013 ")+
   annotate(geom="text", x=2010, y=110, label="FemaleU75\nbreakpoint\nOct 2011-\nSep2012")

    ggsave (
    "Figures/annontatedsegmentedplot_Scotland_U75.png", height=15, width=20, units="cm")

```


##2 breakpoint segmented 
```{r}
my.seg_male2_U75 <-segmented( lmodU75_male, seg_rate.Z = ~timepoint, psi = NA, control = seg.control(K=2))
my.seg_female2_U75<- segmented(lmodU75_female, seg_rate.Z = ~timepoint, psi = NA, control = seg.control(K=2))

summary(my.seg_male2_U75)
summary(my.seg_female2_U75)
```



##AIC and BIC to compare one and two break models
```{r}
AIC(my.seg_male_U75, my.seg_male2_U75)
AIC(my.seg_female_U75, my.seg_female2_U75)
BIC(my.seg_male_U75, my.seg_male2_U75)
BIC(my.seg_female_U75, my.seg_female2_U75)
```


##Construct two break chart  - generate predicted values for 2 break model
```{r}
tidied_UNDER75rates %>%
  filter(sex == "M") %>% 
  mutate(
    twobreak_fit_U75 = fitted(
      my.seg_male2_U75 
     
      )
    ) -> malefitted_U75_2

tidied_UNDER75rates %>%
  filter(sex == "F") %>% 
  mutate(
    twobreak_fit_U75 = fitted(
      my.seg_female2_U75

      )
    ) -> femalefitted_U75_2
plot(malefitted_U75_2$twobreak_fit_U75)
plot(femalefitted_U75_2$twobreak_fit_U75)


```



##Combine male and female observed and predicted - 2 break

```{r}
femalefitted_U75_2 %>% 
  select(
    time, sex, observed = Rate,
    predicted = twobreak_fit_U75
  ) %>% 
  bind_rows(
    malefitted_U75_2 %>% 
      select(
        time, sex, observed = Rate,
        predicted = twobreak_fit_U75
      ) 
  ) -> obs_fit_U75_2break

age <- "Under75"
obs_fit_U75_2break$agegroup = age

obs_fit_U75_2break
```

## Extract breakpoints and CI for 2 break model

```{r}
breakpointmale_U75_2break <- my.seg_male2_U75$psi[, 2]
breakpointfemale_U75_2break <- my.seg_female2_U75$psi[, 2]
breakpoint_SEmale_U75_2break <- my.seg_male2_U75$psi[, 3]
breakpoint_SEfemale_U75_2break <- my.seg_female2_U75$psi[, 3]
breakpoint_low_CImale_U75_2break <- breakpointmale_U75_2break - (breakpoint_SEmale_U75_2break*1.96)
breakpoint_up_CImale_U75_2break <- breakpointmale_U75_2break + (breakpoint_SEmale_U75_2break*1.96)
breakpoint_low_CIfemale_U75_2break <- breakpointfemale_U75_2break - (breakpoint_SEfemale_U75_2break*1.96)
breakpoint_up_CIfemale_U75_2break <- breakpointfemale_U75_2break + (breakpoint_SEfemale_U75_2break*1.96)

breakpointmale_U75_2break
breakpoint_low_CImale_U75_2break
breakpoint_up_CImale_U75_2break
breakpointfemale_U75_2break
breakpoint_low_CIfemale_U75_2break
breakpoint_up_CIfemale_U75_2break
```

## 2 break segmented plot
```{r}
obs_fit_U75_2break %>% 
  ggplot(
    aes (x=time, color=sex)
  ) +
  geom_point(
    aes (y=observed), alpha=0.4)+
  geom_line (
    aes (y=predicted), size=1) +
    ylim(0,1000)+
    labs(x="Year", y="Age-standardised mortality rate", title = "Age-standardised quarterly rolling annual mortality rates", subtitles="males and females, under 75, Scotland, 1990 to 2018: two-break segmented model fitted")+
scale_x_continuous (breaks=c(1990, 1994, 1998, 2002, 2006, 2010, 2014, 2018))

    ggsave (
    "Figures/segmentedplotonly_Scotland_Under75_2break.png", height=15, width=20, units="cm")
    ```


Now to save the values of interest 


```{r}
save(
  
  breakpointmale_U75,
  breakpoint_low_CImale_U75,
  breakpoint_up_CImale_U75,
  breakpointfemale_U75,
  breakpoint_low_CIfemale_U75,
  breakpoint_up_CIfemale_U75,
  
  breakpointmale_U75_2break,
  breakpoint_low_CImale_U75_2break,
  breakpoint_up_CImale_U75_2break,
  breakpointfemale_U75_2break,
  breakpoint_low_CIfemale_U75_2break,
  breakpoint_up_CIfemale_U75_2break,
  
  file = "Data/summary_stats_under75.rdata"
)


```

